<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fetch Post</title>
</head>
<body>
    <h1 class="post-h1" id="title">Loading...</h1>
    <p id="content">Post Body Contents</p>
    <p id="tags">Tags: </p>
    <p id="fileName">File Name</p>
    <!-- Attached Image(s) -->
    <img id="image" alt="Fetched Image" style="max-width:100%; height:auto;">
    <div id="comments-container"></div>

    <script>
        let serverIp = localStorage.getItem("serverIp");

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            sessionStorage.setItem('url', urlParams.get("id"));

            fetch(`http://192.168.28.129:3000/api/posts/66a18aee27e0c4ab1c318fe5}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                const comments = data.message.comments;
                const imageURL = data.message.filePath;
                document.getElementById("title").innerHTML = data.message.title;
                document.getElementById("content").innerHTML = data.message.content;
                document.getElementById("tags").innerHTML = `Tags: ${data.message.tags.join(', ')}`;
                document.getElementById("fileName").innerHTML = data.message.fileName;

                fetch(`http://192.168.28.129:3000/files/${imageURL}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => response.blob())
                .then(blob => {
                    const imageElement = document.getElementById('image');
                    const objectURL = URL.createObjectURL(blob);
                    imageElement.src = objectURL;
                })
                .catch(error => {
                    console.error('Error fetching the image:', error);
                    document.getElementById('image').alt = "Failed to load image";
                });

                console.log(data);

                function generateComments(commentsArray) {
                    const commentsContainer = document.getElementById('comments-container');

                    commentsArray.forEach(comment => {
                        const commentElement = document.createElement('div');
                        commentElement.className = 'comment';

                        const commentName = document.createElement('h3');
                        commentName.textContent = comment.username;
                        commentElement.appendChild(commentName);

                        const commentText = document.createElement('p');
                        commentText.textContent = comment.content;
                        commentElement.appendChild(commentText);

                        const commentDate = document.createElement('span');
                        commentDate.textContent = new Date(comment.createdAt).toLocaleDateString();
                        commentElement.appendChild(commentDate);

                        commentsContainer.appendChild(commentElement);
                    });
                }
                generateComments(comments);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Post Fetch Failed');
            });

            document.addEventListener('DOMContentLoaded', function() {
                const submit = document.getElementById('submit');
                submit.onclick = function() {
                    const textInput = document.getElementsByClassName('button')[0].value;
                    if (textInput.trim() !== '') {
                        fetch(`http://192.168.28.129:3000/api/posts/66a18aee27e0c4ab1c318fe5/comment`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer ' + sessionStorage.getItem('key')
                            },
                            body: JSON.stringify({ comment: textInput }) // Adjust as per your API requirements
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                console.log('Comment submitted successfully.');
                            } else {
                                console.error('Failed to submit comment.');
                            }
                        })
                        .catch(error => {
                            console.error('Error submitting comment:', error);
                        });
                    } else {
                        alert('Please fill out the comment field.');
                    }
                };
            });
        }
    </script>
</body>
</html>
